---
title: "PCA: sports analytics"
author: "Máster en Data Science y Big Data en Finanzas"
date: 'AFI, 2022'
output:
  html_document: 
    css: my-theme.css
    theme: cerulean
    highlight: tango
    number_sections: no
    toc: no
    toc_depth: 1
  pdf_document:
    css: my-theme.css
    theme: cerulean
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 1
editor_options:
  chunk_output_type: console
---


```{r global_options, include=T, echo = F}
knitr::opts_chunk$set(echo = T, warning=FALSE, message=FALSE)
```

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri(file.path("AfiLogo.jpg")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',
               width="173",
               height="77")
```

# Motivation

**Sports analytics:** collection of relevant, historical, statistics that can provide a competitive advantage to a team or individual. 

In this case study, we will analyze data from NBA and try to answer these questions

- How can we know who are the best NBA players based on basketball skills (not only points)?

- Do NBA players have skills that exceed their predefined positions (point guard, shooting guard, small forward, power forward, and center)?

- Can we help NBA coaches to make better decisions? Are they really making right decisions?


```{r}
# delete everything
rm(list=ls()) 

library(tidyverse)
library(GGally) # ggplot2-based visualization of correlations
library(factoextra) # ggplot2-based visualization of pca
```

## Load and prepare data  

Currently, the NBA is composed of 30 teams (29 in the United States and 1 in Canada) with more than 500 players

Data from last season: https://www.basketball-reference.com/leagues/NBA_2021_per_game.html

The dataset contains skill performance of all the players (540) during the last season 2020-21

The glossary is in the web page. Performance is per game


```{r}
players.df = read.csv(file = "NBA.csv")

glimpse(players.df)
```


## Missing values

```{r}
hist(rowMeans(is.na(players.df)))

barplot(colMeans(is.na(players.df)), las=2)
```

Conclusions? What can we do?


## Some feature engineering

We are going to skip the following variables:

- Rk: just the rank

- Player: the name

- Pos: position

- Age

- Tm: team

- G and GS: games played and started (they depend on the coach, not the player's skills)

- MP: minutes played per game (they depend on the coach, not the player's skills)


```{r}
nba <- players.df[,9:ncol(players.df)]

names = players.df[,2]
pos = players.df[,3]
team = players.df[,5]
gp = players.df[,6]
min = players.df[,8]
points = players.df[,30]

dim(nba)
summary(nba)
```

Take care: there are some redundant variables, for instance

- FG, FGA, and percentage (FG.)
- etc. 

We can also remove variable PTS, because PTS=FT+X2P+X3P

The decision about the final variables to consider (input) is very important and will affect the output

Enter here your variables to measure skill performance:

```{r}
nba = nba[,-c(3,6,9,10,13,16,22)]
dim(nba)
```

# Descriptive Analysis

Our input has dimension $p=15$, that implies $2^p$ different relations between the variables.

Dimension 1: univariate analysis for all 15 variables

```{r}
boxplot(nba, las=2, col="darkblue")

# scale or not to scale?
boxplot(scale(nba), las=2, col="darkblue")
```

Dimension 2:  bivariate analysis (scatter plots), in total 105

```{r}
# enter here your code

```

Conclusions?

Dimension 3: proportional to $15^3$ relations, but no way to obtain information... This is why we need an analytical tool to reduce the dimension

Finally, note there are variables highly correlated, especially the most related ones (like ftm and fta)

# PCA

From dimension 15 to dimension 2

```{r}

```

Insights?

This is the same, but using mathematical format; here, eigenvalues denote variances and eigenvectors denote loadings:

```{r}
eigen(R)  
```

## How many components?

```{r}
screeplot(pca,main="Screeplot",col="blue",type="barplot",pch=19)
```

Nicer with factoextra package:

```{r}
fviz_screeplot(pca, addlabels = TRUE)
```

Note with 2 components we explain 78% of variability

## Interpretation of components

First component:

```{r}
barplot(pca$rotation[,1], las=2, col="darkblue")
```

Any hint for the meaning of the 1st PC?

Note the sum of the squared loadings (eigenvectors) is equal to 1

```{r}
sum(pca$rotation[,1]^2)
```

That means squared loadings are easier to interpret than the loadings

I.e. they are like percentages (numbers between 0 and 1)

So let's plot squared loadings instead

They are called contribution of variables to components

```{r}
fviz_contrib(pca, choice = "var", axes = 1)
```

The red dashed line on the graph above indicates the expected average contribution 

If the contribution of the variables were uniform, the expected value would be 1/length(variables) = 1/15 = 6.6%

Now we can rank the players by their first PC scores: best historical players in terms of performance:

```{r}
# The best
names[order(pca$x[,1])][(length(names)-5):length(names)]

# The worst
names[order(pca$x[,1])][1:10]

```

Nikola Jokić was the Most Valuable Player in the season:  https://www.basketball-reference.com/leagues/NBA_2021_leaders.html

Second component:

```{r}
barplot(pca$rotation[,2], las=2, col="darkblue")
```

Any insight about this component? Forward vs Guard?

Maybe we can get more insights by ranking the players using this component:

```{r}
names[order(pca$x[,2])][1:6]
names[order(pca$x[,2])][(length(names)-5):length(names)]
```

Contribution of variables to second component:

Take care because we loose the sign (to get contribution in percentage)

```{r}
fviz_contrib(pca, choice = "var", axes = 2)
```

Once we have interpreted the meaning of the first two components, let's see the contribution of each player to components

For the $i$-th player and first component, the contribution is: $z_{1,i}^2 / \lambda_1 / n$, which is a number between 0 and 1

```{r}
head(get_pca_ind(pca)$contrib[,1]) # this is in %, that is between 0 and 100
head((pca$x[,1]^2)/(pca$sdev[1]^2))/dim(nba)[1] # this is between 0 and 1
```

Let's visualize the top-100 players contributions to first component (global performance):

```{r}
fviz_contrib(pca, choice = "ind", axes = 1, top=100)
```

Let's see the first names:

```{r}
names[order(get_pca_ind(pca)$contrib[,1],decreasing=T)][1:10]
# It is very similar to names[order(pca$x[,1])][1:10] but in percentage
```

Finally, let's make a zoom to see the top-20 players in contributions:

```{r}
names_z1 = names[order(get_pca_ind(pca)$contrib[,1],decreasing=T)]
fviz_contrib(pca, choice = "ind", axes = 1, top=20)+scale_x_discrete(labels=names_z1)
```

## The Biplot

Biplot: observations and variables in same graph (using first 2 components)

```{r}
biplot(pca)
```

Not informative in this case: too many players

Nicer and using contributions (instead of loadings), without players:

```{r}
fviz_pca_var(pca, col.var = "contrib")
```

Nicer but again too much information:

```{r}
fviz_pca_biplot(pca, repel = TRUE)
```

## The Scores

Remember, for the $j$-th principal component: $Z_j = X a_j$, $a_j$ denotes the loadings, and $Z_j$ denotes the scores

Let's plot the first two scores, using colors for minutes played:

```{r}
data.frame(z1=pca$x[,1],z2=pca$x[,2]) %>% 
  ggplot(aes(z1,z2,label=names,color=min)) + geom_point(size=0) +
  labs(title="PCA", x="PC1", y="PC2") +
  theme_bw() + scale_color_gradient(low="lightblue", high="darkblue")+theme(legend.position="bottom") + geom_text(size=2, hjust=0.6, vjust=0, check_overlap = TRUE) 
```

The first two PCs seem independent, but this is not always the same. What is true is that they are always uncorrelated.

The first component is highly correlated with minutes (decided by coaches)

The same, but using colors for games played:

```{r}
data.frame(z1=pca$x[,1],z2=pca$x[,2]) %>% 
  ggplot(aes(z1,z2,label=names,color=gp)) + geom_point(size=0) +
  labs(title="PCA", x="PC1", y="PC2") +
  theme_bw() + scale_color_gradient(low="yellow", high="darkred")+theme(legend.position="bottom") + geom_text(size=2, hjust=0.6, vjust=0, check_overlap = TRUE) 
```

Insights?

Which are the teams with the best players?

```{r}
data.frame(z1=pca$x[,1],team=team) %>% group_by(team) %>% summarise(mean=mean(z1)) %>% arrange(desc(mean))
```

Houston Rockets has the best overall players

Other view: are the better players playing more minutes in a game?

```{r}
data.frame(z1=pca$x[,1],z2=min) %>% 
  ggplot(aes(z1,z2,label=names,color=gp)) + geom_point(size=0) +
  labs(title="Performance", x="PC1", y="Minutes per game") +
  scale_color_gradient(low="lightblue", high="darkblue") +
  theme_bw() + theme(legend.position="bottom") + geom_text(size=2, hjust=0.6, vjust=0, check_overlap = TRUE)
```

Yes, but non-linear... why?

Are the better players playing more games?

```{r}
data.frame(z1=pca$x[,1],z2=gp) %>% 
  ggplot(aes(z1,z2,label=names,color=min)) + geom_point(size=0) +
  labs(title="Performance", x="PC1", y="Games played") +
  scale_color_gradient(low="lightblue", high="darkblue") +
  theme_bw() + theme(legend.position="bottom") + geom_text(size=2, hjust=0.6, vjust=0, check_overlap = TRUE)
```

Somehow, but not too much... why?

