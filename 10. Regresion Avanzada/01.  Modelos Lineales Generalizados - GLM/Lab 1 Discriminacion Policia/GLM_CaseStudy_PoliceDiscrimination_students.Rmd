---
title: "GLM: police treatment and race discrimination"
author: "MÃ¡ster en Data Science y Big Data en Finanzas"
date: 'AFI, 2022'
output:
  html_document: 
    css: my-theme.css
    theme: cerulean
    highlight: tango
    number_sections: no
    toc: no
    toc_depth: 1
  pdf_document:
    css: my-theme.css
    theme: cerulean
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 1
editor_options:
  chunk_output_type: console
---


```{r global_options, include=T, echo = F}
knitr::opts_chunk$set(echo = T, warning=FALSE, message=FALSE)
```

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri(file.path("AfiLogo.jpg")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',
               width="173",
               height="77")
```

# Motivation

Data on police treatment of individuals arrested in Toronto for simple possession of small quantities of marijuana. 

Police have the option of releasing an arrestee with a summons (citation) to appear in court, similar to a traffic ticket; 
alternatively, the individual may be brought to the police station for questioning and possible indictment. 

The principal question of interest is whether and how the probability of release is influenced by the subject's race, age, and other characteristics. 

Context: In Dec. 2002, the Toronto Star examined the issue of racial profiling, by analyzing a data base of 600,000+ arrest records from 1996-2002. 

This is one of the series of articles: https://www.thestar.com/news/gta/knowntopolice/2002/10/19/singled-out.html

Detailed data analysis: https://www.thestar.com/content/dam/thestar/static_images/advancedfindings2010.pdf

More recent: https://www.thestar.com/news/insight/2017/07/06/toronto-marijuana-arrests-reveal-startling-racial-divide.html

Conclusion by newspaper:

- 84% of the arrested individuals are released, but blacks are much less likely to be released

- On the other hand, 16% of the arrested are held in custody, but blacks are much more likely to be held in custody

Note that the proportions of whites and blacks in Toronto population are 92.5% and 7.5%, respectively

Load some packages:

```{r}
# delete everything
rm(list=ls()) 

library(tidyverse)
library(effects)
```

# The dataset

Let's make our own analysis: our dataset is a subset of the larger data considered in the Toronto Star.

```{r}
data(Arrests)
head(Arrests)
```

More than 5000 release observations with 8 variables

The variable checks records the number previous arrests or similar

The target variable is *released*

```{r}
# Summarize the target variable here

```

Unconditionally, 83% of the arrested individuals are released

How this proportion change with characteristics like the race, age, sex, etc.?

# Some descriptive analysis

Let's analyze the target vs some predictors:

```{r}
# Categorical vs numerical
Arrests %>% 
  ggplot(aes(x = released, y = age)) + 
  geom_boxplot(fill="lightblue") +
  labs(title = "Released by age", x = "", y = "", col = "") 
```

Insights about age?

```{r}
# Categorical vs categorical

# Plot the relation between the target and race here

```

Insights about race?

```{r}
# Categorical vs categorical
Arrests %>% 
  ggplot(aes(x= released, fill = sex)) + geom_bar() +
  labs(title = "Released by sex", x = "", y = "", col = "") 
```

Insights about sex?

```{r}
# Categorical vs numerical
Arrests %>% 
  ggplot(aes(x = released, y = checks)) + 
  geom_boxplot(fill="lightblue") +
  labs(title = "Released by previous checks", x = "", y = "", col = "") 

```

Insights about previous checks?

# GLM

In R, we use the following GLM syntax in the glm() function:

- formula: similar to that in linear models

- family: probability distribution of the response (defaul option is normal, other options are: binomial, poisson, gamma, etc.)

- link: the link function (in the case of the binomial distribution, the default link is the logit)

For the exponential families, we can use any of the following

- binomial(link = "logit")

- gaussian(link = "identity")

- Gamma(link = "inverse")

- poisson(link = "log")

- quasipoisson(link = "log")

Remember this R notation for model formulas:

$a:b$ means $a*b$

$a*b$ means $a + b + a*b$

Also, remember a linear model with the log-normal distribution is not the same as a GLM-normal model with the log link:
```{r, eval = FALSE}
# Log-normal distribution: transform the target with a log and then assume it is normal distributed
# (we are modeling E(log(y)) in a linear way)
log.normal.linear <- glm(log(y) ~ x, family=gaussian, data=my.data)
summary(log.normal.linear)

# GLM-normal with the log link: 
# (we are assuming log(E(y)) is linear)
glm.normal.loglink = glm(y ~ x, family=gaussian(link="log"), data=my.data)
summary(glm.normal.loglink)
```

## Let's try our first GLM:

```{r}
arrests.mod <- glm(released ~ colour*age, family=binomial(link="logit"), data=Arrests) 

summary(arrests.mod)
```

Meaning: $\log(p/(1-p)) = 0.7 + 1.65*\text{White} + 0.01*\text{age} - 0.04*\text{White}*\text{age}$

What is the release probability for a 20 year-old black?

$$\eta=\log(p/(1-p)) = 0.7 + 0.01*20 = 0.9$$

Hence, $p=\exp(\eta)/(1+exp(\eta))=0.71$

What about the same probability for a 20yo white?

$$\eta=\log(p/(1-p))=0.7 + 1.65 + 0.01*20 - 0.04*20 = 1.755$$
And then,
$$p=\exp(\eta)/(1+\exp(\eta))=0.85$$

Remember the unconditional probability of released is 0.83

age is not very significant while White and White*age are quite significant

Interactions are difficult to interpret: the interpretation depends on whether the predictors are numeric or categorical

The package effects help to interpret visually

# Interpretation of GLMs: the effects package

Individual effect of colour

```{r}
plot(effect("colour", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")

```

After discounting for other variables, colour is significant (look at the confidence intervals: they do not overlap)

This model tells there is overall difference between the treatment of blacks and whites

Individual effect of age:

```{r}
plot(effect("age", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

The shape of the logit is like an "S" or sigmoidal curve, this is why the lines are curves

Let's analyze the effect of the interaction:

```{r}
plot(effect("colour:age", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

With the interaction better insights!

age helps to increase probability of release if you are white, the opposite if you are black

It is the interaction that makes the interpretation complete:

- young blacks were indeed treated more severely than young whites 

- however for older people, blacks were treated less harshly than whites 
(always controlling for all other predictors)

**Conclusion:** there is race discrimination, but in different directions depending on age

# Diagnosis

Let's focus again on the output of GLM

```{r}
summary(arrests.mod)
```

Deviance: measure of goodness of fit of a GLM. The smaller the better

The null deviance (model with only the intercept) is 4776 with 5225 degrees of freedom

The residual deviance (model with the considered variables) is 4667 points with 5222 degrees of freedom

Hence, the residual deviance has been reduced slightly with a slightly loss in degrees in freedom

AIC: deviance penalized by number of parameters. The smaller the better

Confidence intervals for parameters:

```{r}
confint(arrests.mod)
```

Confidence intervals for the odds ratios:

```{r}
exp(confint(arrests.mod))
```

# An advanced GLM

Let's use now a better model:

```{r}
arrests.mod <- glm(released ~ employed + citizen + checks + colour*year + colour*age, family=binomial, data=Arrests) 

summary(arrests.mod)
```

Note deviance has been decreased from 4667 to 4257, loosing only 13 degrees of freedom

Hence, the AIC has been decreased respect to previous model

This is clearly a better model: more significant parameters, less deviance and AIC

## Effects

```{r}
plot(effect("colour", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

Overall discrimination but smaller than claimed by the Toronto Star

Why? 


```{r}
plot(effect("employed", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

overall discrimination

```{r}
plot(effect("citizen", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

overall (but weaker) discrimination

```{r}
plot(effect("checks", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

very clear effect 
(remember checks records number of previous arrests, convictions, whether on parole, etc.) 

```{r}
plot(effect("colour:age", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

Same conclusion as before but finer

```{r}
plot(effect("colour:year", arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

Up to the year 2000, strong evidence for race discrimination 

From 2001, racial effects in treatment are reduced (because Police were trained from 2000 to reduce racial effects in treatment)

All effects in one graph:

```{r}
plot(allEffects(arrests.mod), ci.style="band", rescale.axis=FALSE, multiline=TRUE, ylab="P(released)", rug=FALSE, main="")
```

# Prediction

```{r}
new.obs = data.frame(colour="Black", age=40, employed="No", citizen="No", checks=2, year=2002)
predict(arrests.mod, newdata=new.obs, type = "response")
```

type = "response" gives the predicted probabilities; the default type gives the prediction on the scale of the linear predictors

The predicted probability of released is 0.73

Remember the unconditional probability of released is 0.83

```{r}
# Change here any value in predictors and see what happens

```


## Prediction intervals

First, predict the link (linear predictor):

```{r}
preds = predict(arrests.mod, newdata=new.obs, type = "link", se.fit=T)
critval <- 1.96 ## approx 95% CI
upr <- preds$fit + (critval * preds$se.fit)
lwr <- preds$fit - (critval * preds$se.fit)
fit <- preds$fit
fit
```

# Then, untransform the link to predict the mean (probability in this case): 

$$\hat{\mu} = g^{-1}(\text{linear predictor})$$

```{r}
fit2 <- arrests.mod$family$linkinv(fit)
upr2 <- arrests.mod$family$linkinv(upr)
lwr2 <- arrests.mod$family$linkinv(lwr)
data.frame(lower=lwr2, prediction=fit2, upper=upr2)
```


