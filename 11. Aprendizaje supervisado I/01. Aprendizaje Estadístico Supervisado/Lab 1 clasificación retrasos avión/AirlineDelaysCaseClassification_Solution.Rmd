---
title: "Case Study: Predicting Airline Delays"
author: "MÃ¡ster en Data Science y Big Data en Finanzas"
date: 'AFI, 2022'
output:
  html_document: 
    css: my-theme.css
    theme: cerulean
    highlight: tango
    number_sections: no
    toc: no
    toc_depth: 1
  pdf_document:
    css: my-theme.css
    theme: cerulean
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 1
editor_options:
  chunk_output_type: console
---
    
```{r global_options, include=T, echo = F}
knitr::opts_chunk$set(echo = T, warning=FALSE, message=FALSE)
```

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri(file.path("AfiLogo.jpg")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',
               width="173",
               height="77")
```

# Introduction 

On any given day, more than 90,000 flights operate in the US. About one-third of these flights are commercial flights, operated by companies like United, American Airlines, etc. Among these commercial flights, 20% suffer from delays due to various reasons. A certain number of delays are unavoidable, due to unexpected events, but some delays could hopefully be avoided if the factors causing delays are better understood and addressed.

<center>
<img src="flight-delays.jpg" width="500"/>
</center>

<br>

In this case study, we will use a dataset with 9,381 flights that occurred in June-August, 2014 between the three busiest US airports:

  - Atlanta (ATL)
  - Los Angeles (LAX)
  - Chicago (ORD)
  
### The dataset  
  
The dataset AirlineDelay.csv includes the following 23 variables:

- Flight = the origin-destination pair (LAX-ORD, ATL-LAX, etc.)
- Carrier = the carrier operating the flight (American Airlines, Delta Air Lines, etc.)
- Month = the month of the flight (June, July, or August)
- DayOfWeek = the day of the week of the flight (Monday, Tuesday, etc.)
- NumPrevFlights = the number of previous flights taken by this aircraft in the same day
- PrevFlightGap = the amount of time between when this flight's aircraft is scheduled to arrive at the airport and when it's scheduled to depart for this flight
- HistoricallyLate = the proportion of time this flight has been late historically
- InsufficientHistory = whether or not we have enough data to determine the historical record of the flight (equal to 1 if we don't have at least 3 records, equal to 0 if we do)
- OriginInVolume = the amount of incoming traffic volume at the origin airport, normalized by the typical volume during the flight's time and day of the week
- OriginOutVolume = the amount of outgoing traffic volume at the origin airport, normalized by the typical volume during the flight's time and day of the week
- DestInVolume = the amount of incoming traffic volume at the destination airport, normalized by the typical volume during the flight's time and day of the week
- DestOutVolume = the amount of outgoing traffic volume at the destination airport, normalized by the typical volume during the flight's time and day of the week
- OriginPrecip = the amount of rain at the origin over the course of the day, in tenths of millimeters
- OriginAvgWind = average daily wind speed at the origin, in miles per hour
- OriginWindGust = fastest wind speed during the day at the origin, in miles per hour
- OriginFog = whether or not there was fog at some point during the day at the origin (1 if there was, 0 if there wasn't)
- OriginThunder = whether or not there was thunder at some point during the day at the origin (1 if there was, 0 if there wasn't)
- DestPrecip = the amount of rain at the destination over the course of the day, in tenths of millimeters
- DestAvgWind = average daily wind speed at the destination, in miles per hour
- DestWindGust = fastest wind speed during the day at the destination, in miles per hour
- DestFog = whether or not there was fog at some point during the day at the destination (1 if there was, 0 if there wasn't)
- DestThunder = whether or not there was thunder at some point during the day at the destination (1 if there was, 0 if there wasn't)
- TotalDelay = the amount of time the aircraft was delayed, in minutes (this is our dependent variable)

### The goal

Predict the response TotalDelay as a function of the other variables

Remember we dealt with this problem using Advanced Regression, but the performance measures were not good enough ($R^2$ around 18% in the best case). This was because this application is quite noisy (the irreducible error may be high)

In these cases, sometimes it is convenient to reduce the noise of the response (at the cost of decreasing also the information): classification approach instead of a regression one

### Load libraries 

```{r}
library(tidyverse)
library(caret)
library(MASS)
```


### Load and prepare data

Let's now divide the Total Delay variable in just three categories:

- No Delay
- Minor Delay
- Major Delay

```{r}
Airlines <- read.csv("AirlineDelay.csv")

# Create the three groups or categories (labels)
Airlines$DelayClass = factor(ifelse(Airlines$TotalDelay == 0, "No Delay", ifelse(Airlines$TotalDelay >= 30, "Major Delay", "Minor Delay")))
levels(Airlines$DelayClass)
```

Is this enough?

```{r}
Airlines$TotalDelay = NULL
```


### Some descriptive analysis for classification

```{r}
# split between training and testing sets
spl = createDataPartition(Airlines$DelayClass, p = 0.8, list = FALSE)  # 80% for training

AirlinesTrain = Airlines[spl,]
AirlinesTest = Airlines[-spl,]

table(AirlinesTrain$DelayClass)
```

Are the classes well balanced?


# Bayes Classifiers

## LDA

```{r}
lda.model <- lda(DelayClass ~ ., data=AirlinesTrain, prior = c(1/6, 1/3, 1/2))

lda.model
```

Note there are two linear classifiers because we have 3 groups

Note prior = c(1/6, 1/3, 1/2) are roughly the class proportions for the training set, hence it's equivalent to

```{r}
lda.model <- lda(DelayClass ~ ., data=AirlinesTrain)
```

In practice, a bit better performance is attained if we shrink the prior probabilities towards 1/3 

Output: posterior probabilities

```{r}
probability = predict(lda.model, newdata=AirlinesTest)$posterior
head(probability)
```

To predict the labels for delay, we apply the Bayes rule of maximum probability

```{r}
prediction <- max.col(probability)
head(prediction)
```

which is equivalent to

```{r}
prediction = predict(lda.model, newdata=AirlinesTest)$class
head(prediction)
```

## Performance

The confusion matrix: predictions in rows, true values in columns (but we can change the order)

```{r}
confusionMatrix(prediction, AirlinesTest$DelayClass)$table
confusionMatrix(prediction, AirlinesTest$DelayClass)$overall[1]
```

## QDA

```{r}
qda.model <- qda(DelayClass ~ ., data=AirlinesTrain, prior = c(1/6, 1/3, 1/2))
qda.model
```

Performance:

```{r}
prediction = predict(qda.model, newdata=AirlinesTest)$class
confusionMatrix(prediction, AirlinesTest$DelayClass)$table
confusionMatrix(prediction, AirlinesTest$DelayClass)$overall[1]
```

## A benchmark model

What is the accuracy on a benchmark model that predicts the most 
frequent outcome (No Delay) for all observations?

```{r}
table(AirlinesTrain$DelayClass)
obs <- max(table(AirlinesTest$DelayClass))
# Accuracy:
obs/nrow(AirlinesTest)
```

Note the benchmark is not so bad... Too much noise...

We can reduce the noise, or increase the accuracy by considering just two classes: delay or no delay

But the information (or precision) of the output will be weaker or less practical...


```{r}
Airlines$DelayClass = factor(ifelse(Airlines$DelayClass == "No Delay", "No Delay", "Delay"))
levels(Airlines$DelayClass)

AirlinesTrain = Airlines[spl,]
AirlinesTest = Airlines[-spl,]

table(AirlinesTrain$DelayClass)
```

Very well-balanced classes

```{r}
lda.model <- lda(DelayClass ~ ., data=AirlinesTrain)
prediction = predict(lda.model, newdata=AirlinesTest)$class
confusionMatrix(prediction, AirlinesTest$DelayClass)$table
confusionMatrix(prediction, AirlinesTest$DelayClass)$overall[1]
```

# With Caret

```{r}
# 5-fold cross validation
ctrl <- trainControl(method = "repeatedcv", 
                     number = 5)

# Define a method
method = "sparseLDA"   # "lda" "PenalizedLDA"  "stepLDA"

# Define a grid for the hyper-parameters
param_grid = expand.grid(NumVars = seq(20, 50, 5), lambda = seq(0, 1, 0.2))

# Train
ldaFit <- train(DelayClass ~ ., 
                method = method, 
                data = AirlinesTrain,
                tuneGrid = param_grid,
                preProcess = c("center", "scale"),
                metric = "Accuracy",
                trControl = ctrl)
print(ldaFit)

# Predict and validate
ldaPred = predict(ldaFit, AirlinesTest)
confusionMatrix(ldaPred,AirlinesTest$DelayClass)
```

Now the accuracy is around 70%
